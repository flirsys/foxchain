<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FOX Wallet</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
  <div id="notice" block mt-1>
    <img src="img/fox-pit.png">
    <div center><font size="6px">—Å–æ–∑–¥–∞–π—Ç–µ</font><br>–∏–ª–∏<br><font size="6px">–∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ</font><br>–∫–æ—à–µ–ª–µ–∫</div>
  </div>

  <div id="account" block rainbow mt-1>
    <div info class="bold">FOX Wallet</div>
    <div class="balance" center mt-1 mb-1 font-large bold onclick="switchBalance()">... FOX</div>
    <div class="address" label onclick="copyToClipboard(this)" mt-1 bold></div>
    <button mini title="–û–±–Ω–æ–≤–∏—Ç—å"><img src="img/refresh.png"></button>
  </div>

  <div center class="acts" mt-1>
    <button id="btn-send" onclick="openMenu('#tx-section')">–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã</button>
    <button id="btn-keys" onclick="openMenu('#keys')">–∫–ª—é—á–∏</button>
    <div id="toast" class="toast"></div>
  </div>
  
  <div id="tx-section" pp-menu>
    <div block>
      <div class="block-header"><div>üí∏</div>–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</div>
      <input type="text" id="txRecipient" placeholder="–∞–¥—Ä–µ—Å fox...">
      <div style="position: relative; display: inline-block; width: 100%;">
        <input type="text" id="txAmount" placeholder="0.000000" mt-1>
        <span style="position: absolute;right: 7px;color: #aaa;pointer-events: none;top: 26px;font-size: 22px;">FOX</span>
      </div>
      <input type="text" id="txComm" placeholder="–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." mt-1 style="padding: 9px 54px 9px 9px;">
      <button id="sign-send-tx" mt-1>–ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <div id="tx-list-section" block mt-1>
    <div class="block-header">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
    <div id="tx-list"></div>
  </div>

  <div id="txInfo" pp-menu>
    <div block>
      <div class="block-header">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</div>
      <pre><code class="json"></code></pre>
    </div>
  </div>
  <div id="keys" pp-menu>
    <div block>
      <div id="wallet-locked">
        <button id="create-wallet">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ—à–µ–ª–µ–∫</button>
        <div class="block-header" style="text-align:center; font-size:1em; margin-top:1.5em;">–∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <textarea id="pubKeyImport" rows="5" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á..."></textarea>
        <textarea id="privKeyImport" rows="5" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á..." mt-1></textarea>
        <button id="import-wallet" mt-1>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
  
      <div id="wallet-unlocked">
        <div info class="bold" mb-1 style="color:#dc3545;">–°–ö–û–ü–ò–†–£–ô–¢–ï –ò –°–û–•–†–ê–ù–ò–¢–ï</div>
        <label>–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á</label>
        <textarea id="pubKey" rows="5" readonly onclick="copyToClipboard(this)"></textarea>
        <label class="mt-1">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á</label>
        <textarea id="privKey" rows="5" readonly onclick="copyToClipboard(this)"></textarea>
        <button mt-1 id="logout">–í—ã–π—Ç–∏ –∏ –∑–∞–±—ã—Ç—å –∫–ª—é—á–∏</button>
      </div>
    </div> 
  </div>

  <script>
    const _UNITS_PER_MAIN_UNIT = 1_000_000;
    const DEFAULT_FEE_ = 50;
    const nodeaddr = "";//"http://0.0.0.0:8080/";
    let keyPair = null;

    $(document).ready(function() {
      loadWalletFromStorage();
      $('#account>button').click(refreshAccountInfo);
      $('#create-wallet').click(createNewWallet);
      $('#import-wallet').click(importWallet);
      $('#logout').click(logout);
      $('#sign-send-tx').click(signAndSendTx);
      $('#wallet-unlocked').hide();
      $('#account').hide();
      $('#notice').show();
      $('#tx-list-section').hide();
    });

    let toastTimeout;
    let lastMessage = '';
    let repeatCount = 0;
    function showToast(message, type = 'success', img = '') {
      if (message === lastMessage) {
        repeatCount++;
      } else {
        lastMessage = message;
        repeatCount = 1;
      }
      const displayMessage = (repeatCount > 1 ? `<span>x${repeatCount}</span> ` : '') + message;
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
      $('#toast')
        .html((img !== '' ? `<img src='img/${img}.png'>` : '') + "<div>" + displayMessage + "</div>")
        .attr('class', `toast ${type} show`);
      toastTimeout = setTimeout(() => {
        $('#toast').attr('class', 'toast');
        toastTimeout = null;
        lastMessage = '';
        repeatCount = 0;
      }, 3000);
    }

    function copyToClipboard(element) {
      const text = element.textContent || element.value;
      navigator.clipboard.writeText(text).then(() => {
        showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏!', 'error');
      });
    }

    async function createNewWallet() {
      try {
        keyPair = await window.crypto.subtle.generateKey(
          { name: 'RSASSA-PKCS1-v1_5', modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: 'SHA-256' },
          true, ['sign', 'verify']
        );
        await saveAndDisplayWallet();
        showToast('–ù–æ–≤—ã–π –∫–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success', 'fox-happy1');
      } catch (e) {
        showToast(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ${e.message}`, 'error', 'fox-cry2');
      }
    }

    async function importWallet() {
      const privKeyB64 = $('#privKeyImport').val().trim();
      const pubKeyB64  = $('#pubKeyImport').val().trim();
      if (!privKeyB64 || !pubKeyB64) {
        showToast('–í—Å—Ç–∞–≤—å—Ç–µ –æ–±–∞ –∫–ª—é—á–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'error', 'fox-cry2');
        return;
      }
      try {
        const privateKey = await window.crypto.subtle.importKey('pkcs8', base64ToArrayBuffer(privKeyB64), { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }, true, ['sign']);
        const publicKey = await window.crypto.subtle.importKey('spki', base64ToArrayBuffer(pubKeyB64), { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }, true, ['verify']);
        keyPair = { privateKey, publicKey };
        localStorage.setItem('wallet_privKey', privKeyB64);
        localStorage.setItem('wallet_pubKey', pubKeyB64);
        await displayWalletInfo(pubKeyB64);
        showToast('–ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success', 'fox-happ1');
      } catch (e) {
        showToast(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${e.message}`, 'error', 'fox-cry2');
      }
    }

    async function saveAndDisplayWallet() {
      const privKeyB64 = arrayBufferToBase64(await window.crypto.subtle.exportKey('pkcs8', keyPair.privateKey));
      const pubKeyB64 = arrayBufferToBase64(await window.crypto.subtle.exportKey('spki', keyPair.publicKey));
      localStorage.setItem('wallet_privKey', privKeyB64);
      localStorage.setItem('wallet_pubKey', pubKeyB64);
      await displayWalletInfo(pubKeyB64);
    }

    async function displayWalletInfo(pubKeyB64) {
      $('#pubKey').val(pubKeyB64);
      $('#privKey').val(localStorage.getItem('wallet_privKey'));
      $('#account>.address').text(await getAddressFromPublicKey(pubKeyB64));
      $('#wallet-locked').hide();
      $('#wallet-unlocked').show();
      $('#btn-send').show();
      $('#account').show();
      $('#notice').hide();
      $('#tx-list-section').show();
      await refreshAccountInfo();
    }

    async function loadWalletFromStorage() {
      const privKeyB64 = localStorage.getItem('wallet_privKey');
      const pubKeyB64 = localStorage.getItem('wallet_pubKey');
      if (privKeyB64 && pubKeyB64) {
        try {
          const privateKey = await window.crypto.subtle.importKey('pkcs8', base64ToArrayBuffer(privKeyB64), { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }, true, ['sign']);
          const publicKey = await window.crypto.subtle.importKey('spki', base64ToArrayBuffer(pubKeyB64), { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }, true, ['verify']);
          keyPair = { privateKey, publicKey };
          await displayWalletInfo(pubKeyB64);
          showToast('–ö–æ—à–µ–ª–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.', 'success', 'fox-happy1');
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–∞: ${e.message}`, 'error', 'fox-cry2');
          logout();
        }
      } else {
        $('#btn-send').hide();
        $('#wallet-locked').show();
        $('#wallet-unlocked').hide();
        $('#account').hide();
        $('#notice').show();
        $('#tx-list-section').hide();
        openMenu('#keys')
      }
    }

    function logout() {
      keyPair = null;
      localStorage.removeItem('wallet_privKey');
      localStorage.removeItem('wallet_pubKey');
      $('#wallet-locked').show();
      $('#wallet-unlocked').hide();
      $('#btn-send').hide();
      $('#account').hide();
      $('#notice').show();
      $('#tx-list-section').hide();
      $('#privKeyImport').val('');
      $('#pubKeyImport').val('');
      $('#pubKey').val('');
      $('#privKey').val('');
      openMenu('#keys');
      showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–æ—à–µ–ª—å–∫–∞.', 'success', 'fox-cry1');
    }

    var menu = null;
    var menuContent = null;
    let startY = 0;
    let currentY = 0;
    let isDragging = false;
    let isScrollingInternal = false;

    function openMenu(el) {
      menu = document.querySelector(el + '[pp-menu]');
      menuContent = menu.querySelector('div');
      menu.classList.add('open');
      document.body.classList.add('menu-open');
      menu.style.transform = '0';
      menu.style.background = "#000000cb";
      menu.addEventListener('touchstart', startDrag);
      menu.addEventListener('touchmove', moveDrag);
      menu.addEventListener('touchend', endDrag);
      menu.addEventListener('touchcancel', () => {
        isDragging = false;
        menuContent.style.transition = 'transform 0.3s ease';
        menuContent.style.transform = 'translateY(0)';
      });
      menu.addEventListener('mousedown', startDrag);
      menu.addEventListener('mousemove', moveDrag);
      menu.addEventListener('mouseup', endDrag);
      menuContent.addEventListener('wheel', handleInternalScroll);
    }
    function closeMenu() {
      menu.classList.remove('open');
      document.body.classList.remove('menu-open');
      menuContent.style.transform = 'translateY(0)';
      if (menuContent) {
        menuContent.removeEventListener('wheel', handleInternalScroll);
      }
    }
    function startDrag(e) {
      const target = e.target;
      const isScrollable = target.scrollHeight > target.clientHeight || target.scrollWidth > target.clientWidth;
      if (target.tagName === 'TEXTAREA' || isScrollable) {
        isDragging = false;
        isScrollingInternal = true;
        return;
      }
      startY = e.touches ? e.touches[0].clientY : e.clientY;
      isDragging = true;
      isScrollingInternal = false;
      menuContent.style.transition = 'none';
    }
    function moveDrag(e) {
      if (isScrollingInternal) return;
      if (!isDragging) return;
      currentY = e.touches ? e.touches[0].clientY : e.clientY;
      let diff = currentY - startY;
      let maxDragDistance = 200;
      if (diff >= maxDragDistance - 10) menu.style.background = "#63565644";
      else menu.style.background = "#000000cb";
      if (diff > 20)
        if (diff > 0 && diff < maxDragDistance) {
          menuContent.style.transform = `translateY(${diff - 20}px)`;
        }
    }
    function endDrag(e) {
      if (isScrollingInternal) {
        isScrollingInternal = false;
        return;
      }
      isDragging = false;
      let endY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
      let diff = endY - startY;
      menuContent.style.transition = 'transform 0.3s ease';
      if (diff > 100) {
        closeMenu();
      } else {
        menuContent.style.transform = 'translateY(0)';
      }
    }
    function handleInternalScroll(e) {
    }

    var isFoxBalance = true;
    function switchBalance(){
      isFoxBalance = !isFoxBalance;
      refreshAccountInfo();
    }
    var angle = 0;
    var FOXtoRUB = 0;
    async function refreshAccountInfo() {
      if (angle == -(360 * 10)) angle = 0;
      angle -= 360;
      $('#account>button[mini]').css('transform', 'rotate(' + angle + 'deg)');
      const address = $('#account>.address').text();
      if (!address) return;
      try {
        const res = await fetch(`${nodeaddr}api/account/${address}`);
        const data = await res.json();
        const $infoElAddr = $('#account>.address');
        const $infoElBal = $('#account>.balance');
        if (data.error) {
          $infoElAddr.text(`${address}`);
          if (isFoxBalance) $infoElBal.text(`0 FOX`);
          else $infoElBal.html(`0 ‚ÇΩ<br><span>—Ü–µ–Ω–∞ –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è</span>`);
        } else {
          $infoElAddr.text(`${data.address}`);
          if (isFoxBalance) $infoElBal.text(`${data.balance} FOX`);
          else $infoElBal.html(`${(data.balance * FOXtoRUB).toFixed(2)} ‚ÇΩ<br><span>—Ü–µ–Ω–∞ –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è</span>`);
        }
        await loadTransactions();
      } catch (e) {
        showToast(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${e.message}`, 'error', 'fox-cry2');
      }
    }

    function openTX(tx){
      openMenu("#txInfo");
      $("#txInfo>div>textarea").val();
      block = document.querySelector("#txInfo>div>pre>code");
      block.textContent = JSON.stringify(tx, null, 2);
      block.removeAttribute('data-highlighted');
      hljs.highlightElement(block); 
    }
    async function loadTransactions() {
      const address = $('#account>.address').text();
      if (!address) return;
      try {
        const res = await fetch(`${nodeaddr}api/account/${address}/tx`);
        const data = await res.json();
        const txs = data.txs || [];
        const $txList = $('#tx-list');
        $txList.empty();
        if (txs.length === 0) {
          $txList.append('<div class="tx-empty">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.</div>');
          return;
        }
        txs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        for (const tx of txs) {
          const amount = formatToMain(tx.value || 0);
          const incoming = tx.recipient === address;
          const direction = incoming ? (tx.status === 0 ? 'üóìÔ∏è +' : '+') : (tx.status === 0 ? 'üóìÔ∏è -' : '-');
          const statusClass = tx.status === 1 ? "accepted" : tx.status === 2 ? "rejected" : "pending";
          const bg = tx.status == 0 ? "#ffa5002e" : incoming ? "#00800024" : "#0077512e";
          const statusText = tx.status === 1 ? "‚úÖ" : tx.status === 2 ? "‚ùå" : "‚è≥";
          const partyText = incoming ? "–û—Ç" : "–ö–æ–º—É";
          const comment = tx.comment ? `<div class="comment">${tx.comment}</div>` : '';
          const time = tx.timestamp ? new Date(tx.timestamp).toLocaleString("ru-RU", { dateStyle:'short', timeStyle:'short' }) : '';
          const fee = !incoming ? (tx.fee !== undefined && tx.fee > 0) ? `<span title="–ö–æ–º–∏—Å—Å–∏—è">Fee: ${formatToMain(tx.fee)} FOX</span>` : '' : '';
          const txJson = encodeURIComponent(JSON.stringify(tx));
          const button = `<span onclick="openTX(JSON.parse(decodeURIComponent('${txJson}')))">–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</span>`;

          $txList.append(`
            <div class="tx-row ${statusClass}" style="background: ${bg}">
              <div class="main">
                <div>
                  <span class="direction">${direction}</span>
                  <span style="font-weight:600;">${amount} FOX</span>
                </div>
                ${tx.status == 1 ? button : ''}
              </div>
              <div class="to"><span class="text">${partyText}:</span> <span label onclick="copyToClipboard(this)">${incoming ? tx.sender : tx.recipient}</span></div>
              ${comment}
              <div class="tx-meta">
                <span>${fee}</span>
                <span>${time} ${statusText}</span>
              </div>
            </div>
          `);
        }
      } catch (e) {
        showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${e.message}`, 'error', 'fox-cry2');
      }
    }

    function formatToMain(Amount) {
      return (Amount / _UNITS_PER_MAIN_UNIT);
    }

    function getFromInput(selector) {
      const val = $(selector).val().replace(',', '.').trim();
      if (!val) return null;
      const num = parseFloat(val);
      if (isNaN(num) || num < 0) return null;
      if (val.includes('.') && val.split('.')[1].length > 6) return null;
      return Math.round(num * _UNITS_PER_MAIN_UNIT);
    }

    function getTxSignString(sender, recipient, value, fee, nonce, comment) {
      return `${sender}|${recipient}|${value}|${fee}|${nonce}|${comment}`;
    }

    async function signAndSendTx() {
      const recipient = $('#txRecipient').val().trim();
      const value = getFromInput('#txAmount');
      const comment = $('#txComm').val().trim();
      if (!recipient || value === null || value <= 0) {
        showToast('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É!', 'error', 'fox-cry2');
        return;
      }
      if (comment.length > 255) {
        showToast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π', 'error', 'fox-cry2');
        return;
      }
      try {
        const sender = $('#account>.address').text();
        const accRes = await fetch(`${nodeaddr}api/account/${sender}`);
        const accData = await accRes.json();
        if (accData.error) {
          showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞.', 'error', 'fox-cry2');
          return;
        }
        const nonce = accData.nonce;
        const fee = DEFAULT_FEE_;
        const txData = getTxSignString(sender, recipient, value, fee, nonce, comment);
        const signatureBuffer = await window.crypto.subtle.sign({ name: 'RSASSA-PKCS1-v1_5' }, keyPair.privateKey, new TextEncoder().encode(txData));
        const signature = arrayBufferToBase64(signatureBuffer);
        const publicKey = arrayBufferToBase64(await window.crypto.subtle.exportKey('spki', keyPair.publicKey));
        const res = await fetch(`${nodeaddr}api/tx/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sender,
            recipient,
            value: value.toString(),
            fee: fee.toString(),
            nonce: nonce.toString(),
            comment,
            signature,
            publicKey
          })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –•—ç—à: ${data.txHash.substring(0,10)}...`, 'success', 'fox-happy1');
          $('#txRecipient, #txAmount, #txComm').val('');
          setTimeout(refreshAccountInfo, 1000);
        } else {
          showToast(`${data.message}`, 'error', 'fox-cry2');
        }
      } catch (e) {
        showToast(`${e.message}`, 'error', 'fox-cry2');
      }
    }

    async function getAddressFromPublicKey(pubKeyB64) {
      const pubKeyBuffer = base64ToArrayBuffer(pubKeyB64);
      const hashBuffer = await window.crypto.subtle.digest('SHA-256', pubKeyBuffer);
      const hash = new Uint8Array(hashBuffer);
      let hex = '';
      for (const b of hash) {
        hex += b.toString(16).padStart(2, '0');
      }
      const arr = hex.split('');
      let posF = hash[0] % 5;
      let posO = hash[1] % 5;
      while (posO === posF) posO = (posO + 1) % 5;
      let posX = hash[2] % 5;
      while (posX === posF || posX === posO) posX = (posX + 1) % 5;
      arr[posF] = 'f';
      arr[posO] = 'o';
      arr[posX] = 'x';
      return arr.join('');
    }

    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }
  </script>
</body>
</html>